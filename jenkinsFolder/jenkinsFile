pipeline {
    agent { docker { image 'maven:3.3.3'}}
        stages {
           stage('load properties file..') {
                  steps {
                       script {
                             props = readProperties file:'commonUtility/pipeline.properties'
			     deploProps = readProperties file:'commonUtility/dockerDeployment.properties'
                             echo 'LOAD SUCCESS'
                             }
                      }    
               }
               stage('read git url file..') {
                  steps {
                         git url: props.gitUrl,
                         branch: props.branchName
                         echo 'READ SUCCESS'
                        }    
                   }
              stage('sonar scan..') {
                  steps {
                         sh props.buildSonarScan
                         echo 'SONAR SCAN SUCCESS'
                        }    
                   }
              stage('maven build..') {
                  steps {
                         sh props.mavenClean
                         echo 'BUILD SUCCESS'
                        }    
                   } 
		   stage('UPLOAD ARTIFACT') {
                  steps {
			script {
				server = Artifactory.server props.ARTIFACTORY_ID
				uploadSpec = """{
                		"files": [
                    		{
                       			"pattern": "target/*.war",
                        		"target": "app-repo/target/"
                    		}
                    		]
                		}"""
            			server.upload(uploadSpec)
				}
				echo 'UPLOAD ARTIFACT SUCCESS'
				}
			}
			stage('DEPLOY') {
                  steps {
		  	script {
				try	{
					sh deployProps.dockerContainerId
					output=readFile('result').trim()
					if(output!=null)
					{
					sh deployProps.dockerContainerRm
					}
					}catch (err)
					{
					echo 'DELETE FAILED'
					}
					sh deployProps.dockerDeploy
					sh deployProps.dockerRestart
					echo 'DEPLOY SUCCESS'	
				      }			
				  
                               }
                       }
                }
         }
